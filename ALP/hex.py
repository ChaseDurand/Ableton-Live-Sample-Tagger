import sys
from io import StringIO


# Manually copying data from xml for testing
test1 = '000000000206000200000C4D6163696E746F73682048440000000000000000000000000000000000000042440001FFFFFFFF1F7072657474792066617220726973657220752346464646464646462E7761760000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000FFFFFFFF00000A206375000000000000000000000000000E417564696F20486F6D65627265770002006B2F3A55736572733A6368617365647572616E643A4465736B746F703A536F756E64205265736F75726365733A496E746572636570743A417564696F20486F6D65627265773A707265747479206661722072697365722075706C69667465722073776565702066782E77617600000E004E00260070007200650074007400790020006600610072002000720069007300650072002000750070006C00690066007400650072002000730077006500650070002000660078002E007700610076000F001A000C004D006100630069006E0074006F007300680020004800440012006955736572732F6368617365647572616E642F4465736B746F702F536F756E64205265736F75726365732F496E746572636570742F417564696F20486F6D65627265772F707265747479206661722072697365722075706C69667465722073776565702066782E77617600001300012F00001500020012FFFF0000'
test2 = '0000000001CA000200000C4D6163696E746F73682048440000000000000000000000000000000000000042440001FFFFFFFF124861726477617265204C617A65722E616966000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000004149464600000000FFFFFFFF00000A20637500000000000000000000000000024658000200682F3A55736572733A6368617365647572616E643A4D757369633A41626C65746F6E3A466163746F7279205061636B733A536B697474657220616E6420537465703A53616D706C65733A4F6E652053686F74733A46583A4861726477617265204C617A65722E616966000E00260012004800610072006400770061007200650020004C0061007A00650072002E006100690066000F001A000C004D006100630069006E0074006F007300680020004800440012006655736572732F6368617365647572616E642F4D757369632F41626C65746F6E2F466163746F7279205061636B732F536B697474657220616E6420537465702F53616D706C65732F4F6E652053686F74732F46582F4861726477617265204C617A65722E616966001300012F00001500020012FFFF0000'
test3 =   '00000000023A000200000C4D6163696E746F73682048440000000000000000000000000000000000000042440001FFFFFFFF1F53445F566F7843686F705F4C6F6F705F41652346464646464646462E7761760000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000FFFFFFFF00000A20637500000000000000000000000000054C6F6F7073000002008E2F3A55736572733A6368617365647572616E643A4465736B746F703A536F756E64205265736F75726365733A5061636B733A536C617465204469676974616C3A53445F45444D5F53616D706C655061636B3A53616D706C65733A566F63616C2043686F70733A4C6F6F70733A53445F566F7843686F705F4C6F6F705F4165646963756C615F3136305F452E776176000E0046002200530044005F0056006F007800430068006F0070005F004C006F006F0070005F004100650064006900630075006C0061005F003100360030005F0045002E007700610076000F001A000C004D006100630069006E0074006F007300680020004800440012008C55736572732F6368617365647572616E642F4465736B746F702F536F756E64205265736F75726365732F5061636B732F536C617465204469676974616C2F53445F45444D5F53616D706C655061636B2F53616D706C65732F566F63616C2043686F70732F4C6F6F70732F53445F566F7843686F705F4C6F6F705F4165646963756C615F3136305F452E776176001300012F00001500020012FFFF0000'
test4 = '00000000023A000200000C4D6163696E746F7368204844000000000000000000000000000000D73EE2DE482B000000941DDB1F4E55414E20534F4E4152202D2044697274792052233934314532302E776176000000000000000000000000000000000000000000000000000000000000000000941E20D8EA5A280000000000000000FFFFFFFF000009200000000000000000000000000000000442617373001000080000D73F1B1E0000001100080000D8EA926800000001001C00941DDB00941DDA0018CF120007AE570006C81F0006C80E000669510002007C4D6163696E746F73682048443A55736572733A006368617365647572616E643A004465736B746F703A00536F756E64205265736F75726365733A005061636B733A00476C69746368205769746820467269656E64733A00426173733A004E55414E20534F4E4152202D2044697274792052233934314532302E776176000E00440021004E00550041004E00200053004F004E004100520020002D00200044006900720074007900200052006500650063006500200069006E00200044002E007700610076000F001A000C004D006100630069006E0074006F007300680020004800440012006A55736572732F6368617365647572616E642F4465736B746F702F536F756E64205265736F75726365732F5061636B732F476C69746368205769746820467269656E64732F426173732F4E55414E20534F4E4152202D20446972747920526565636520696E20442E776176001300012F00001500020012FFFF0000'

def hex_parse(data):

    path = bytearray.fromhex(data)
    found_path = ''
    '''
    #Redirecting stdout so I can save the print output because decoding the hex is giving me problems
    #stdout is reset to previous value at end
    old_stdout = sys.stdout
    sys.stdout = mystdout = StringIO()
    print(path)
    sys.stdout = old_stdout
    path = mystdout.getvalue()
    #Thanks stackoverflow.
    '''

    #Finds : which looks to be uniquely found in the sample path
    #I should probably figure out what the rest of the hex is and how it's structured
    #This implementation ignores volumes, which appears to be stored early in the hex, so I'm unsure how it handles samples from another volume, such as a USB drive
    i = 0
    while i < len(path):
        if (path[i] != 0x00) and (path[i] != 0xFF):
            first_index = i
            length = path[i]
            offset = 1
            found_string = ''
            while (offset <= length) and (path[first_index+offset] != 0x00) and (path[first_index+offset] != 0xFF):
                if(first_index+offset) == len(path):
                    print('woah now')
                found_string += chr(path[first_index+offset])
                #print(chr(path[first_index + offset]), end='')
                offset += 1
            if offset == length+1:
                #possible valid string
                if found_string != '/':
                    found_path = found_string
            i = first_index+offset
            #i = i+length
        #print(path[i])
        i += 1
    '''
    pathstart = path.find(":",50) #path starts at first colon - some samples have colon earlier in string and I have no idea why
    pathend = path.find("\\",pathstart) #path ends at first backslash following path
    path = path[pathstart:pathend] #reduce string to just the range of the found path
    path = path.replace(":","/")
    #if path == '/':
    #    print("ahhhhh!")
    return path
    '''
    found_path = '/' + found_path
    return(found_path)


#hex_parse(test1)
#hex_parse(test2)
#hex_parse(test3)
#hex_parse(test4)